workdir: <flow123d-workdir>
init-shell: |
  set -x
  module purge
  module use  /storage/praha1/home/jan-hybs/modules
  module load metabase
  module load gcc-6.4.0
  module load mpich-3.0.2-gcc
  module load python-3.6.2-gcc
  module load python36-modules-gcc
  module load cmake/3.12.0
  module load ccache/3.4.2
  module list -t
  export FLOW123D_HOME=<flow123d-home>


install:
  - name: compile-flow123d
    output: stdout
    git:
      - url: https://github.com/flow123d/flow123d.git
        commit: <arg.commit.flow123d>   # checkout to this commit
        branch: <arg.branch.flow123d>   # under this branch's name
        
    shell: |
      cd flow123d
      cp config/config-cihpc-meta.cmake config.cmake
      make -j8
      bin/flow123d --help


test:
  - name: integration
    output: stdout+log
    repeat: 1

        
    variables:
      - matrix:
        - benchmark: 01_square_regular_grid
        - mesh:
          - 1_15662_el
          - 2_31498_el
          - 3_47122_el
          - 4_62302_el
          # - 5_78010_el
          # - 6_93742_el
          # - 7_109042_el
          # - 8_124498_el
          # - 9_139918_el
          # - 10_155122_el
          # - 11_171110_el
          # - 12_186658_el
          # - 13_201610_el
          # - 14_217138_el
          # - 15_233242_el
          # - 16_248510_el
      - matrix:
        - benchmark: 02_cube_123d
        - mesh:
          - 1_15786_el
          - 2_29365_el
          - 3_47367_el
          - 4_58803_el
          # - 5_78379_el
          # - 6_89683_el
          # - 7_104912_el
          # - 8_118696_el
          # - 9_139280_el
          # - 10_152389_el
          # - 11_165361_el
          # - 12_183061_el
          # - 13_197786_el
          # - 14_211246_el
          # - 15_233079_el
          # - 16_261685_el
      - matrix:
        - benchmark: 03_mesh_read
        - mesh:
          - 1_15786_el
          - 2_29365_el
          - 4_58803_el
          - 8_118696_el
          - 16_261685_el
      - matrix:
        - benchmark: 04_kravi_hora
        - mesh:
          - 1_212773_el
      - matrix:
        - benchmark: 05_dfn_2d
        - mesh:
          - 1_1618_el
          
    shell: |
      echo "BENCHMARK: {benchmark}, INPUT-DIR: {mesh}"
      flow123d/bin/runtest bench_data/benchmarks/{benchmark}/ --cpu 1 --status-file --no-compare -a -- -i {mesh}
